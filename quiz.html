<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>クイズ</title>
  <link rel="stylesheet" href="style.css">
  <!-- data.js は同期読み込み（deferなし） -->
  <script src="assets/data.js"></script>
</head>
<body>
  <main class="wrap">
    <div class="row space">
      <a id="back" class="back" href="subject.html">← 戻る</a>
      <div>ポイント：<span id="pts">0</span></div>
    </div>

    <section id="stage" class="panel">
      <div id="progress" class="muted"></div>
      <div id="imageBox"></div>
      <h2 id="questionText"></h2>

      <input id="answerInput" class="input" placeholder="ここに答えを入力">
      <div class="row">
        <button id="submit" class="primary">答える</button>
        <button id="skip" class="ghost">わからない</button>
      </div>

      <div id="feedback"></div>
    </section>
  </main>

  <script>
    /***** 設定：GASのWebアプリURL（あなたのURL） *****/
    const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyPZFejTFMwWieBeZRJ15KFtNuEAYyzha6QXpKbx0Oy3SnCogfS-n86C6fDKorUKaOg/exec';

    /***** URLパラメータ *****/
    const qs = new URLSearchParams(location.search);
    const subject = qs.get('subject') || 'social';
    const mode    = qs.get('mode')    || 'miss_unans';
    const scope   = qs.get('scope')   || 'all';   // 'all' | 'week'
    const weekReq = qs.get('week')    || '';
    const order   = qs.get('order')   || 'normal'; // 'normal' | 'random' | 'desc'
    document.getElementById('back').href = `subject.html?subject=${encodeURIComponent(subject)}`;

    /***** ポイント *****/
    const KEY_PTS = 'mb_points';
    const ptsEl = document.getElementById('pts');
    const getPts = () => Number(localStorage.getItem(KEY_PTS) || 0);
    const setPts = v => { localStorage.setItem(KEY_PTS, String(v)); ptsEl.textContent = v; };
    setPts(getPts());

    /***** ステータス（正解/不正解） *****/
    const statusKey = id => `mb_status_${id}`;
    const getStatus = id => localStorage.getItem(statusKey(id));
    const setStatus = (id, v) => localStorage.setItem(statusKey(id), v);

    /***** 要素参照 *****/
    const progressEl = document.getElementById('progress');
    const qTextEl = document.getElementById('questionText');
    const imgBox = document.getElementById('imageBox');
    const inputEl = document.getElementById('answerInput');
    const feedbackEl = document.getElementById('feedback');

    /***** CSVパーサ *****/
    function parseCSV(text){
      const rows = [];
      let cur = [], cell = '', inQuote = false;
      for (let i=0; i<text.length; i++){
        const c = text[i], n = text[i+1];
        if (inQuote){
          if (c === '"' && n === '"'){ cell += '"'; i++; }
          else if (c === '"'){ inQuote = false; }
          else { cell += c; }
        }else{
          if (c === '"'){ inQuote = true; }
          else if (c === ','){ cur.push(cell); cell=''; }
          else if (c === '\n'){ cur.push(cell); rows.push(cur); cur=[]; cell=''; }
          else if (c === '\r'){ /* skip */ }
          else { cell += c; }
        }
      }
      if (cell.length>0 || cur.length>0){ cur.push(cell); rows.push(cur); }
      return rows;
    }

    async function fetchCSV(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('CSV fetch failed');
      return parseCSV(await res.text());
    }

    /***** CSV -> 問題配列（BOM対策） *****/
    function rowsToQuestions(rows){
      if (!rows.length) return [];
      const header = rows[0].map(h => (h || '')
        .toString()
        .replace(/^\ufeff/, '')
        .trim()
        .toLowerCase()
      );
      const idx = name => header.indexOf(name);

      const qi = {
        id: idx('id'),
        week: idx('week'),
        question: idx('question'),
        answer: idx('answer'),
        alt: idx('alt_answers'),
        img: idx('image_url'),
        enabled: idx('enabled')
      };

      const out = [];
      for (let r=1; r<rows.length; r++){
        const row = rows[r];

        const enabled = ((qi.enabled>=0 ? row[qi.enabled] : '') || '')
          .toString().trim().toUpperCase();
        if (enabled === 'FALSE') continue;

        const id = (qi.id>=0 ? row[qi.id] : '').toString().trim();
        const question = (qi.question>=0 ? row[qi.question] : '').toString().trim();
        if (!id || !question) continue;

        const accepts = [];
        const ans = (qi.answer>=0 ? row[qi.answer] : '').toString().trim();
        const alt = (qi.alt>=0 ? row[qi.alt] : '').toString();
        if (ans) accepts.push(ans);
        if (alt) alt.split(/[|｜]/).map(s=>s.trim()).filter(Boolean).forEach(s=>accepts.push(s));

        out.push({
          id,
          text: question,
          week: (qi.week>=0 ? row[qi.week] : '').toString().trim(),
          image: (qi.img>=0 ? row[qi.img] : '').toString().trim(),
          type: 'typing',
          accept: accepts
        });
      }
      return out;
    }

    async function loadQuestions(){
      const index = (window.DATA && window.DATA[subject]) || { lessons: [] };
      let all = [];
      for (const t of index.lessons){
        const url = t.csv || t.file;
        if (!url) continue;
        if (/\.json($|\?)/.test(url)){
          const r = await fetch(url, { cache: 'no-store' });
          all = all.concat(await r.json());
        }else{
          const rows = await fetchCSV(url);
          all = all.concat(rowsToQuestions(rows));
        }
      }
      if (scope === 'week' && weekReq){
        const want = weekReq.trim();
        all = all.filter(q => (q.week || '').trim() === want);
      }
      return all;
    }

    /***** 出題 *****/
    let pool = [];
    let idx = 0;
    let answered = false;

    function normalize(s){
      return (s||'').toString().trim().replace(/\s+/g,'').replace(/[ーｰ−]/g,'-').toLowerCase();
    }

    function render(){
      if (idx >= pool.length){
        qTextEl.textContent = '本日の出題は以上です！';
        imgBox.innerHTML = '';
        document.getElementById('stage').classList.add('done');
        progressEl.textContent = '';
        // 最後に残りログを送る
        flushAnswers();
        return;
      }
      const q = pool[idx];
      progressEl.textContent = `問題 ${idx+1} / ${pool.length}`;
      qTextEl.textContent = q.text;              // week表示なし
      imgBox.innerHTML = q.image ? `<img class="qimg" src="${q.image}" alt="">` : '';
      inputEl.value = '';
      answered = false;
      inputEl.focus();
      feedbackEl.textContent = '';
    }

    function advance(){ idx++; render(); }

    /***** ログ（GAS送信） *****/
    // 匿名ユーザーID
    const USER_ID_KEY = 'mb_user_id';
    function getUserId(){
      let id = localStorage.getItem(USER_ID_KEY);
      if (!id){
        id = 'u_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
        localStorage.setItem(USER_ID_KEY, id);
      }
      return id;
    }
    // セッションID
    const SESSION_ID = 's_' + Date.now().toString(36) + Math.random().toString(36).slice(2);

    const ANSWER_BUFFER = [];
    const FLUSH_EVERY = 5;

    async function flushAnswers(){
      if (!ANSWER_BUFFER.length) return;
      // できるだけ軽く
      const payload = { type:'answer', records: ANSWER_BUFFER.splice(0, ANSWER_BUFFER.length) };
      try{
        await fetch(LOG_ENDPOINT, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
      }catch(e){
        console.warn('log failed', e);
        // 失敗したら次回に再送できるよう戻す
        payload.records.forEach(r => ANSWER_BUFFER.push(r));
      }
    }

    function pushAnswerLog(record){
      ANSWER_BUFFER.push(record);
      if (ANSWER_BUFFER.length >= FLUSH_EVERY) flushAnswers();
    }

    // ページ離脱時に残りを送る（対応していないブラウザもあるので best-effort）
    window.addEventListener('beforeunload', () => {
      if (!ANSWER_BUFFER.length) return;
      const body = JSON.stringify({ type:'answer', records: ANSWER_BUFFER });
      if (navigator.sendBeacon){
        const blob = new Blob([body], {type:'application/json'});
        navigator.sendBeacon(LOG_ENDPOINT, blob);
      }else{
        // フォールバック（完全保証ではない）
        fetch(LOG_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body });
      }
    });

    /***** 判定処理（クリック/Enter共通） *****/
    function judge(){
      const q = pool[idx];
      const userRaw = inputEl.value;
      const user = normalize(userRaw);
      if (!user){ inputEl.focus(); return; }
      const ok = (q.accept || []).some(a => normalize(a) === user);

      // ログ1件
      pushAnswerLog({
        ts_iso: new Date().toISOString(),
        user_id: getUserId(),
        session_id: SESSION_ID,
        subject,
        week: weekReq || '',
        lesson_id: '',               // 必要なら data.js の id を渡す実装にもできます
        question_id: q.id,
        status: ok ? 'correct' : 'incorrect',
        user_answer: userRaw,
        is_correct: ok,
        points_delta: ok ? 1 : 0,
        elapsed_ms: 0,              // 必要になったら計測を追加
        order,
        scope
      });

      if (ok){
        setStatus(q.id, 'correct');
        setPts(getPts()+1);
        feedbackEl.innerHTML = `<div class="ok">正解！ +1pt</div>`;
      }else{
        setStatus(q.id, 'incorrect');
        const first = q.accept?.[0] || '';
        feedbackEl.innerHTML = `<div class="ng">不正解… 正答例：${first}</div>`;
      }
      answered = true;
    }

    /***** ボタン操作 *****/
    document.getElementById('submit').addEventListener('click', () => {
      if (!answered){ judge(); } else { advance(); }
    });

    document.getElementById('skip').addEventListener('click', () => {
      const q = pool[idx];
      pushAnswerLog({
        ts_iso: new Date().toISOString(),
        user_id: getUserId(),
        session_id: SESSION_ID,
        subject,
        week: weekReq || '',
        lesson_id: '',
        question_id: q.id,
        status: 'skipped',
        user_answer: '',
        is_correct: false,
        points_delta: 0,
        elapsed_ms: 0,
        order,
        scope
      });

      feedbackEl.innerHTML = `<div class="hint">スキップ（未回答）</div>`;
      answered = true;
      setTimeout(advance, 200);
    });

    /***** エンターキー操作 *****/
    document.addEventListener('keydown', e => {
      if (e.key === 'Enter'){
        e.preventDefault();
        if (!answered){
          judge();     // 1回目のEnter：判定
        } else {
          advance();   // 2回目のEnter：次の問題
        }
      }
    });

    /***** 初期化 *****/
    (async function init(){
      try{
        const all = await loadQuestions();
        pool = (mode === 'miss_unans')
          ? all.filter(q => getStatus(q.id) !== 'correct')
          : all.slice();

        // 並び替え
        if (order === 'random'){
          for (let i = pool.length - 1; i > 0; i--){
            const j = Math.floor(Math.random() * (i + 1));
            [pool[i], pool[j]] = [pool[j], pool[i]];
          }
        }else if (order === 'desc'){
          pool.sort((a,b) => (b.id > a.id ? 1 : -1));
        }

        if (!pool.length){
          qTextEl.textContent = '出題対象がありません（条件に合う問題がない／全問正解など）';
          imgBox.innerHTML = '';
          document.getElementById('stage').classList.add('done');
          return;
        }
        render();
      }catch(e){
        qTextEl.textContent = '問題の読み込みに失敗しました。共有設定またはURLをご確認ください。';
        console.error(e);
      }
    })();
  </script>
</body>
</html>
