<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>範囲とモードの選択</title>
  <link rel="stylesheet" href="style.css">
  <!-- data.js は defer なし（先に読み込む） -->
  <script src="assets/data.js"></script>
</head>
<body>
  <main class="wrap">
    <a id="back" class="back" href="index.html">← TOPへ</a>
    <h1 id="subjectTitle">科目</h1>

    <!-- 出題範囲 -->
    <section class="panel">
      <h2>出題範囲</h2>
      <label class="row"><input type="radio" name="scope" value="all" checked> 全授業</label>
      <div class="row">
        <label><input type="radio" name="scope" value="week"> 授業（週）を選ぶ：</label>
        <select id="weekSelect" disabled>
          <option value="">（読み込み中）</option>
        </select>
      </div>
      <small class="muted">※週（WEEK）はシートの <code>week</code> 列から自動生成します</small>
      <div id="weekError" class="muted" style="color:#ff9090; display:none;"></div>
    </section>

    <!-- 出題モード -->
    <section class="panel">
      <h2>出題モード</h2>
      <label class="row"><input type="radio" name="mode" value="miss_unans" checked> 不正解＆未回答のみ</label>
      <label class="row"><input type="radio" name="mode" value="all"> 全問</label>
    </section>

    <!-- 出題順序 -->
    <section class="panel">
      <h2>出題順序</h2>
      <label class="row"><input type="radio" name="order" value="normal" checked> 通常（CSVの順）</label>
      <label class="row"><input type="radio" name="order" value="random"> ランダム</label>
      <label class="row"><input type="radio" name="order" value="desc"> 降順</label>
    </section>

    <div class="row end">
      <button id="start" class="primary">クイズ開始</button>
    </div>
  </main>

  <script>
    const qs = new URLSearchParams(location.search);
    const subject = qs.get('subject') || 'social';
    const titleMap = { math:'算数', kokugo:'国語', science:'理科', social:'社会' };
    document.getElementById('subjectTitle').textContent = `科目：${titleMap[subject] || subject}`;
    document.getElementById('back').href = `index.html`;

    const weekSel = document.getElementById('weekSelect');
    const weekErr = document.getElementById('weekError');
    const scopeRadios = [...document.querySelectorAll('input[name="scope"]')];

    function updateWeekEnabled(){
      const scope = document.querySelector('input[name="scope"]:checked').value;
      weekSel.disabled = (scope !== 'week');
    }
    scopeRadios.forEach(r => r.addEventListener('change', updateWeekEnabled));
    updateWeekEnabled();

    // 軽量CSVパーサ
    function parseCSV(text){
      const rows = [];
      let cur = [], cell = '', inQuote = false;
      for (let i=0; i<text.length; i++){
        const c = text[i], n = text[i+1];
        if (inQuote){
          if (c === '"' && n === '"'){ cell += '"'; i++; }
          else if (c === '"'){ inQuote = false; }
          else { cell += c; }
        }else{
          if (c === '"'){ inQuote = true; }
          else if (c === ','){ cur.push(cell); cell=''; }
          else if (c === '\n'){ cur.push(cell); rows.push(cur); cur=[]; cell=''; }
          else if (c === '\r'){ /* skip */ }
          else { cell += c; }
        }
      }
      if (cell.length>0 || cur.length>0){ cur.push(cell); rows.push(cur); }
      return rows;
    }

    async function fetchCSV(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('CSV fetch failed: ' + res.status);
      return parseCSV(await res.text());
    }

    async function loadWeeks(){
      try{
        weekErr.style.display = 'none';
        weekSel.innerHTML = '<option value="">（読み込み中）</option>';

        // data.js が未定義/科目未登録の防御
        if (!window.DATA || !window.DATA[subject] || !window.DATA[subject].lessons?.length){
          weekSel.innerHTML = '<option value="">（未設定）</option>';
          weekErr.textContent = 'assets/data.js の lessons が見つかりません。';
          weekErr.style.display = 'block';
          return;
        }

        // 先頭のレッスン1枚を使用（1科目＝1タブ運用）
        const lesson = window.DATA[subject].lessons[0];
        const url = lesson.csv || lesson.file;
        if (!url){
          weekSel.innerHTML = '<option value="">（未設定）</option>';
          weekErr.textContent = 'レッスンの csv / file が未設定です。';
          weekErr.style.display = 'block';
          return;
        }

        const rows = await fetchCSV(url);
        if (!rows.length){ weekSel.innerHTML = '<option value="">（データなし）</option>'; return; }

        const header = rows[0].map(h => (h||'').toString().replace(/^\ufeff/,'').trim().toLowerCase());
        const wIdx = header.indexOf('week');
        const enIdx = header.indexOf('enabled');

        if (wIdx < 0){
          weekSel.innerHTML = '<option value="">（week 列がありません）</option>';
          weekErr.textContent = 'シート1行目に "week" 列を追加してください。';
          weekErr.style.display = 'block';
          return;
        }

        const set = new Set();
        for (let r=1; r<rows.length; r++){
          const row = rows[r];
          // enabled が FALSE の行は除外（空欄/TRUEは採用）
          const enabled = (enIdx>=0 ? (row[enIdx]||'').toString().trim().toUpperCase() : '');
          if (enabled === 'FALSE') continue;

          const w = (row[wIdx] || '').toString().trim();
          if (w) set.add(w);
        }

        const weeks = Array.from(set).sort((a,b)=> a.localeCompare(b,'ja',{numeric:true}));
        weekSel.innerHTML = '';
        if (!weeks.length){
          weekSel.innerHTML = '<option value="">（週が見つかりません）</option>';
          return;
        }
        weeks.forEach(w=>{
          const opt=document.createElement('option');
          opt.value=w; opt.textContent=w;
          weekSel.appendChild(opt);
        });
      }catch(err){
        console.error(err);
        weekSel.innerHTML = '<option value="">（取得に失敗）</option>';
        weekErr.textContent = 'CSVの取得に失敗しました。スプレッドシートの共有を「リンクを知っている全員：閲覧可」にしてください。';
        weekErr.style.display = 'block';
      }
    }

    // 起動時に週リストを取得
    loadWeeks();

    // 開始ボタン
    document.getElementById('start').addEventListener('click', () => {
      const mode  = document.querySelector('input[name="mode"]:checked').value;
      const scope = document.querySelector('input[name="scope"]:checked').value;
      const order = document.querySelector('input[name="order"]:checked').value;

      const p = new URLSearchParams({ subject, mode, scope, order });
      if (scope === 'week') {
        const w = weekSel.value;
        if (!w){ alert('週（WEEK）を選んでください'); return; }
        p.set('week', w);
      }
      location.href = `quiz.html?${p.toString()}`;
    });
  </script>
</body>
</html>
