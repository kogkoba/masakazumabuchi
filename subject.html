<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>範囲とモードの選択</title>
  <link rel="stylesheet" href="style.css">
  <script src="assets/data.js"></script>
</head>
<body>
  <main class="wrap">
    <a id="back" class="back" href="index.html">← TOPへ</a>
    <h1 id="subjectTitle">科目</h1>

    <!-- 出題範囲 -->
    <section class="panel">
      <h2>出題範囲</h2>
      <label class="row"><input type="radio" name="scope" value="all" checked> 全授業</label>
      <div class="row">
        <label><input type="radio" name="scope" value="week"> 授業（週）を選ぶ：</label>
        <select id="weekSelect" disabled>
          <option value="">（読み込み中）</option>
        </select>
      </div>
      <small class="muted">※週（WEEK）はシートの <code>week</code> 列から自動生成します</small>
    </section>

    <!-- 出題モード -->
    <section class="panel">
      <h2>出題モード</h2>
      <label class="row"><input type="radio" name="mode" value="miss_unans" checked> 不正解＆未回答のみ</label>
      <label class="row"><input type="radio" name="mode" value="all"> 全問</label>
    </section>
    <!-- 出題順序 -->
    <section class="panel">
      <h2>出題順序</h2>
      <label class="row"><input type="radio" name="order" value="normal" checked> 通常（CSVの順）</label>
      <label class="row"><input type="radio" name="order" value="random"> ランダム</label>
      <label class="row"><input type="radio" name="order" value="desc"> 降順</label>
    </section>


    <div class="row end">
      <button id="start" class="primary">クイズ開始</button>
    </div>
  </main>

  <script>
    const qs = new URLSearchParams(location.search);
    const subject = qs.get('subject') || 'social';
    const titleMap = { math:'算数', kokugo:'国語', science:'理科', social:'社会' };
    document.getElementById('subjectTitle').textContent = `科目：${titleMap[subject] || subject}`;
    document.getElementById('back').href = `index.html`;

    const data = (window.DATA && window.DATA[subject]) || { lessons: [] };
    const weekSel = document.getElementById('weekSelect');

    // ===== CSVパーサ =====
    function parseCSV(text){
      const rows = [];
      let cur = [], cell = '', inQuote = false;
      for (let i=0; i<text.length; i++){
        const c = text[i], n = text[i+1];
        if (inQuote){
          if (c === '"' && n === '"'){ cell += '"'; i++; }
          else if (c === '"'){ inQuote = false; }
          else { cell += c; }
        }else{
          if (c === '"'){ inQuote = true; }
          else if (c === ','){ cur.push(cell); cell=''; }
          else if (c === '\n'){ cur.push(cell); rows.push(cur); cur=[]; cell=''; }
          else if (c === '\r'){ /* skip */ }
          else { cell += c; }
        }
      }
      if (cell.length>0 || cur.length>0){ cur.push(cell); rows.push(cur); }
      return rows;
    }

    async function fetchCSV(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('CSV fetch failed');
      return parseCSV(await res.text());
    }

    async function loadWeeks(){
      weekSel.innerHTML = '<option value="">（読み込み中）</option>';
      try{
        const lesson = data.lessons[0];  // ← 最初の1枚だけを使う前提
        if (!lesson) { weekSel.innerHTML = '<option value="">（未設定）</option>'; return; }
        const rows = await fetchCSV(lesson.csv);
        if (!rows.length){ weekSel.innerHTML = '<option value="">（データなし）</option>'; return; }
        const header = rows[0].map(h => h.trim());
        const wIdx = header.indexOf('week');
        const enIdx = header.indexOf('enabled');
        const set = new Set();
        for (let r=1; r<rows.length; r++){
          const row = rows[r];
          if (enIdx >= 0){
            const en = (row[enIdx] || '').toString().trim().toUpperCase();
            if (en === 'FALSE') continue;
          }
          const w = (wIdx >= 0 ? (row[wIdx] || '').toString().trim() : '');
          if (w) set.add(w);
        }
        const weeks = Array.from(set).sort((a,b)=>a.localeCompare(b,'ja',{numeric:true}));
        weekSel.innerHTML = '';
        weeks.forEach(w=>{
          const opt=document.createElement('option');
          opt.value=w; opt.textContent=w;
          weekSel.appendChild(opt);
        });
      }catch(e){
        console.error(e);
        weekSel.innerHTML = '<option value="">（取得失敗）</option>';
      }
    }

    loadWeeks();

    // scopeラジオでweek選択を有効化
    const scopeRadios = [...document.querySelectorAll('input[name="scope"]')];
    function updateWeekEnabled(){
      const scope = document.querySelector('input[name="scope"]:checked').value;
      weekSel.disabled = (scope !== 'week');
    }
    scopeRadios.forEach(r=>r.addEventListener('change',updateWeekEnabled));
    updateWeekEnabled();

    // 開始document.getElementById('start').addEventListener('click', () => {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const scope = document.querySelector('input[name="scope"]:checked').value;
  const order = document.querySelector('input[name="order"]:checked').value;  // ← 追加

  const p = new URLSearchParams({ subject, mode, scope, order });
  if (scope === 'week') {
    const w = weekSel.value;
    if (!w){ alert('週（WEEK）を選んでください'); return; }
    p.set('week', w);
  }
  location.href = `quiz.html?${p.toString()}`;
});

  </script>
</body>
</html>
